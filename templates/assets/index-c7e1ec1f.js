import{k as ne,g as Q,j as le,i as oe,e as H,f as re}from"./index-6c720e4c.js";import{g as z}from"./getList-b7db4d33.js";import{d as I,_ as W,r as f,f as ue,G as q,H as J,S as n,R as d,M as e,Q as D,a3 as P,c as M,F as K,V as ce,j as ie,l as k,h as de}from"./vue-080993b5.js";import{u as _e}from"./website-a01091dc.js";import{u as he}from"./download-9fdf4d81.js";import{ag as pe,aq as me,R as fe,ao as X,ar as ge,U as be,O as N,as as ke,I as j,F as G,a7 as ve}from"./naiveUI-1e53cf3e.js";import"./lodash-5fc50ca6.js";import"./ionicons5-b765452e.js";import"./baseStyle-3d03bd09.js";const{message:r}=Q(),we=async()=>await z("schedule/tasks"),ye=async c=>await z("schedule/exec",{task_id:c}),Se=async()=>await z("schedule/schedules"),Le=async c=>await z("schedule/schedule",c),xe=async()=>await z("schedule/crontabs"),Ce=async c=>{const{msg:u,code:p}=await le("schedule/schedule",c);switch(p){case 0:return r==null||r.success(u),!0;default:return r==null||r.error(u),!1}},O=async c=>{const{msg:u,code:p}=await ne("schedule/schedule",c);switch(p){case 0:return r==null||r.success(u),!0;default:return r==null||r.error(u),!1}},$e=async c=>{const{msg:u,code:p}=await oe("schedule/schedule",c);switch(p){case 0:return r==null||r.success(u),!0;default:return r==null||r.error(u),!1}},Fe=I({__name:"schedule-form",setup(c){const u=Y(),{refScheduleForm:p,scheduleForm:t,addScheduleFormRules:_,taskSelectList:S}=W(u),{saveSchedule:L,removeSchedule:h}=u,x=_e(),{mySiteList:g,siteList:C}=W(x),{getMySiteList:b,getSiteList:v}=x,w=he(),{getDownloaderList:$}=w,{downloaderList:F}=W(w),T=["schedule.tasks.auto_get_rss","schedule.tasks.auto_get_torrents","schedule.tasks.auto_sign_in","schedule.tasks.auto_get_status","schedule.tasks.auto_remove_brush_task","schedule.tasks.auto_push_to_downloader"],a=[],s=f([]),i=f(!1),y=async()=>{i.value=!0,await L(),i.value=!1},R=async V=>{const o={"schedule.tasks.auto_get_rss":"brush_rss","schedule.tasks.auto_get_torrents":"brush_free","schedule.tasks.auto_push_to_downloader":"brush_free","schedule.tasks.auto_remove_brush_task":"brush_free","schedule.tasks.auto_get_hash_by_category":"brush_free"};s.value=g.value.filter(B=>{var m;return((m=B.torrents)==null?void 0:m.startsWith("https://"))&&C.value.find(U=>U.id===B.site)[o[V]]})};return ue(async()=>{await b(),await v(),await $(),t.value.id!==0&&await R(t.value.task)}),(V,o)=>{const B=pe,m=me,U=fe,Z=X,E=ge,ee=be,A=N,te=ke,ae=j;return q(),J(K,null,[n(ee,{ref:e(p),model:e(t),rules:e(_),class:"site-form","inline-message":"","label-placement":"left","status-icon":"",size:"small"},{default:d(()=>[n(m,{label:"选择任务",path:"task"},{default:d(()=>[n(B,{value:e(t).task,"onUpdate:value":[o[0]||(o[0]=l=>e(t).task=l),R],disabled:e(t).id!==0,placeholder:e(t).id!==0?"":"请选择要添加的任务",options:e(S),filterable:""},null,8,["value","disabled","placeholder","options"])]),_:1}),n(m,{label:"任务名称",path:"name"},{default:d(()=>[n(U,{value:e(t).name,"onUpdate:value":o[1]||(o[1]=l=>e(t).name=l),clearable:"",placeholder:"请为你的任务命名","show-word-limit":""},null,8,["value"])]),_:1}),n(m,{label:"开启任务",path:"enabled",required:"",inline:""},{default:d(()=>[n(Z,{value:e(t).enabled,"onUpdate:value":o[2]||(o[2]=l=>e(t).enabled=l),round:!1},null,8,["value"])]),_:1}),n(m,{label:"时间分钟",path:"crontab.minute",required:""},{default:d(()=>[n(U,{value:e(t).crontab.minute,"onUpdate:value":o[3]||(o[3]=l=>e(t).crontab.minute=l),clearable:"",placeholder:"执行时间：分钟，支持Crontab表达式","show-word-limit":""},null,8,["value"])]),_:1}),n(m,{label:"时间小时",path:"crontab.hour",required:""},{default:d(()=>[n(U,{value:e(t).crontab.hour,"onUpdate:value":o[4]||(o[4]=l=>e(t).crontab.hour=l),clearable:"",placeholder:"执行时间：小时，支持Crontab表达式","show-word-limit":""},null,8,["value"])]),_:1}),e(t).task.length>0&&T.includes(e(t).task)?(q(),D(m,{key:0,label:"选择站点",path:"args","label-placement":"top"},{default:d(()=>[n(E,{ref:"transfer",value:e(t).args,"onUpdate:value":o[5]||(o[5]=l=>e(t).args=l),"virtual-scroll":"",options:e(s).map((l,se)=>({label:l.nickname,value:l.id})),"source-filterable":""},null,8,["value","options"])]),_:1})):P("",!0),e(t).task.length>0&&a.includes(e(t).task)?(q(),D(m,{key:1,label:"选择下载器",path:"args","label-placement":"top"},{default:d(()=>[n(E,{ref:"transfer",value:e(t).args,"onUpdate:value":o[6]||(o[6]=l=>e(t).args=l),"virtual-scroll":"",options:e(F).map((l,se)=>({label:l.name,value:l.id})),"source-filterable":""},null,8,["value","options"])]),_:1})):P("",!0)]),_:1},8,["model","rules"]),n(ae,{justify:"center"},{default:d(()=>[e(t).id!==0?(q(),D(te,{key:0,onPositiveClick:o[7]||(o[7]=l=>e(h)(e(t).id))},{trigger:d(()=>[n(A,{type:"error"},{default:d(()=>[M(" 删 除 ")]),_:1})]),default:d(()=>[M(" 确定删除此任务吗？ ")]),_:1})):P("",!0),n(A,{type:"primary",loading:e(i),onClick:y},{default:d(()=>[M(" 保存 ")]),_:1},8,["loading"])]),_:1})],64)}}}),Y=ce("task",()=>{const c=f(),u=f([{label:"请选择任务",value:0}]),p=f(),t=f(),{dialog:_}=Q(),S=f(),L={id:0,name:"",task:"",enabled:!0,crontab:{minute:"10",hour:"8",day_of_week:"*",day_of_month:"*",month_of_year:"*"},args:[],kwargs:{}},h=f({...L}),x=ie({task:[{required:!0,message:"请选择要添加的任务",trigger:"change"}],name:[{required:!0,message:"请为你的任务命名",trigger:"blur"}],"crontab.hour":[{required:!0,message:"请填写执行时间：小时",trigger:"blur"}],"crontab.minute":[{required:!0,message:"请填写执行时间：分钟",trigger:"blur"}]}),g=async()=>{var a;c.value=await we(),u.value.length=1,(a=c.value)==null||a.forEach(s=>{u.value.push({label:s.desc,value:s.task})})},C=async()=>{t.value=await xe()},b=async()=>{await g(),await C(),p.value=await Se()},v=async a=>{var s;if(a===0)h.value={...L};else{const i=await Le({schedule_id:a});typeof i.args=="string"&&(i.args=JSON.parse(i.args));const y=(s=t.value)==null?void 0:s.find(R=>R.id===i.crontab);h.value=i,h.value.crontab=y}_==null||_.info({title:a===0?"添加任务":`编辑任务：${h.value.name}`,content:()=>k(Fe),closable:!0})},w=async()=>{var s;await((s=S.value)==null?void 0:s.validate()),(h.value.id===0?await Ce(h.value):await O(h.value))&&(await b(),_==null||_.destroyAll())},$=async a=>{await $e({schedule_id:a})&&(await b(),_==null||_.destroyAll())},F=async a=>{await ye(a)};return{columns:f([{title:"任务名称",key:"name",width:200,minWidth:185,fixed:"left"},{title:"任务",key:"task",width:180,minWidth:165,render(a){var i;const s=(i=c.value)==null?void 0:i.find(y=>a.task===y.task);return s?k(G,{style:{marginRight:"6px"},type:"primary",bordered:!1,ghost:!0},{default:()=>s==null?void 0:s.desc}):null}},{title:"执行时间",key:"crontab",minWidth:155,width:180,render(a){var i;const s=(i=t.value)==null?void 0:i.find(y=>a.crontab===y.id);return k(G,{style:{marginRight:"6px"},type:"info",bordered:!1},{default:()=>s==null?void 0:s.express})}},{title:"开启",key:"enabled",minWidth:88,width:100,render(a){return k(X,{size:"small",round:!1,value:a.enabled,"onUpdate:value":async s=>{a.enabled=s,await O(a)&&await g()}},{checked:()=>"开启",unchecked:()=>"关闭","checked-icon":()=>"✅","unchecked-icon":()=>k(H,{icon:"CloseSharp",color:"red",size:16})})}},{title:"上次运行",key:"last_run_at",width:180,minWidth:165},{key:"actions",title:"操作",width:150,align:"center",render(a){return k(j,{justify:"center"},{default:()=>[k(N,{size:"small",type:"warning",onClick:()=>F(a.id)},{default:()=>"运行"}),k(N,{size:"small",type:"info",onClick:()=>v(a.id)},{default:()=>"编辑"})]})}}]),taskList:c,scheduleList:p,scheduleForm:h,addScheduleFormRules:x,refScheduleForm:S,taskSelectList:u,getTaskList:g,getScheduleList:b,editSchedule:v,saveSchedule:w,removeSchedule:$}}),De=I({__name:"index",setup(c){const{isMobile:u,isPad:p,isDesktop:t}=re(),_=Y(),{columns:S,scheduleList:L}=W(_),{getScheduleList:h,editSchedule:x}=_,g=f(!1),C=b=>b.task;return de(async()=>{g.value=!0,await h(),g.value=!1}),(b,v)=>{const w=N,$=j,F=ve;return q(),J(K,null,[n($,{class:"mb-2 pt-2 flex items-center"},{default:d(()=>[n(w,{type:"warning",size:"small",class:"flex items-center",onClick:e(h)},{default:d(()=>[n(H,{icon:"RefreshSharp"})]),_:1},8,["onClick"]),n(w,{size:"small",type:"success",onClick:v[0]||(v[0]=T=>e(x)(0))},{default:d(()=>[M(" 添加 ")]),_:1})]),_:1}),n(F,{columns:e(S),data:e(L),loading:e(g),"min-height":e(u)?580:680,"row-key":C,bordered:"","flex-height":"","max-height":"720",size:"small",striped:""},null,8,["columns","data","loading","min-height"])],64)}}});export{De as default};
